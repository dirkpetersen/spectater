<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Requirements Evaluator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .result-box {
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
            font-size: 24px;
            font-weight: bold;
            text-align: center;
        }
        .green { background-color: #d4edda; color: #155724; }
        .yellow { background-color: #fff3cd; color: #856404; }
        .orange { background-color: #ffe5d0; color: #ad4f09; }
        .red { background-color: #f8d7da; color: #721c24; }

        body.dark-mode .result-box.green {
            background-color: #1a4d3c;
            color: #90ee90;
        }

        body.dark-mode .result-box.yellow {
            background-color: #4d4d1a;
            color: #ffeb99;
        }

        body.dark-mode .result-box.orange {
            background-color: #4d3c1a;
            color: #ffc299;
        }

        body.dark-mode .result-box.red {
            background-color: #4d1a1a;
            color: #ff9999;
        }

        /* Oregon State University Styling */
        :root {
            --osu-orange: #D73F09;
            --osu-black: #000000;
            --osu-gray: #333333;
            --bg-primary: #ffffff;
            --text-primary: #000000;
            --text-secondary: #666666;
            --border-color: #ddd;
        }

        body.dark-mode {
            --bg-primary: #1a1a1a;
            --text-primary: #ffffff;
            --text-secondary: #aaaaaa;
            --border-color: #444;
        }

        body {
            font-family: 'Open Sans', 'Kievit', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            font-size: 16px;
            line-height: 1.6;
            color: var(--text-primary);
            background-color: var(--bg-primary);
            font-weight: 400;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        h1 {
            font-family: 'Stratum 2', 'Georgia', 'Times New Roman', serif;
            color: var(--osu-orange);
            font-weight: 700;
            font-size: 2.5rem;
            line-height: 1.2;
            border-bottom: 3px solid var(--osu-orange);
            padding-bottom: 15px;
            margin-bottom: 20px;
            letter-spacing: -0.5px;
        }

        h2 {
            font-family: 'Georgia', 'Times New Roman', serif;
            color: var(--text-primary);
            font-weight: 700;
            font-size: 1.75rem;
            line-height: 1.3;
            margin-top: 25px;
            margin-bottom: 15px;
        }

        h3 {
            font-family: 'Open Sans', 'Kievit', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            color: var(--text-primary);
            font-weight: 600;
            font-size: 1.25rem;
            line-height: 1.4;
            margin-top: 15px;
            margin-bottom: 10px;
        }

        p {
            margin-bottom: 15px;
            letter-spacing: 0.3px;
            font-family: 'Open Sans', 'Kievit', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            color: var(--text-primary);
        }

        .form-label {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        .btn-primary {
            background-color: var(--osu-orange);
            border-color: var(--osu-orange);
            font-weight: 600;
        }

        .btn-primary:hover {
            background-color: var(--osu-black);
            border-color: var(--osu-black);
        }

        .form-control {
            border-color: var(--border-color);
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }

        .form-control:focus {
            border-color: var(--osu-orange);
            box-shadow: 0 0 0 0.2rem rgba(215, 63, 9, 0.25);
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }

        /* Dark mode specific adjustments */
        body.dark-mode .form-control {
            border-color: #555;
        }

        body.dark-mode .card {
            background-color: #2a2a2a;
            border-color: #444;
        }

        body.dark-mode .alert {
            background-color: #2a2a2a;
            border-color: #444;
            color: var(--text-primary);
        }

        body.dark-mode table {
            color: var(--text-primary);
            border-color: #444;
        }

        body.dark-mode .table-sm th {
            background-color: #3a3a3a;
            color: var(--text-primary);
        }

        body.dark-mode .table-sm td {
            border-color: #444;
            color: var(--text-primary);
        }

        body.dark-mode .table-success {
            background-color: #d4edda !important;
            color: #000000 !important;
        }

        body.dark-mode .table-success td {
            color: #000000 !important;
        }

        body.dark-mode .table-danger {
            background-color: #f8d7da !important;
            color: #000000 !important;
        }

        body.dark-mode .table-danger td {
            color: #000000 !important;
        }

        body.dark-mode .table-warning {
            background-color: #fff3cd !important;
            color: #000000 !important;
        }

        body.dark-mode .table-warning td {
            color: #000000 !important;
        }

        body.dark-mode pre {
            background-color: #2a2a2a !important;
            color: var(--text-primary);
        }

        body.dark-mode code {
            color: var(--text-primary);
        }

        #policyDisplay, #submissionDisplay {
            color: #666 !important;
        }

        body.dark-mode #policyDisplay, body.dark-mode #submissionDisplay {
            color: #aaa !important;
        }

        #uploadedFileName {
            background-color: var(--bg-primary);
            border-left-color: var(--osu-orange);
            color: #000000 !important;
            border: 1px solid var(--border-color);
        }

        #uploadedFileName strong {
            color: #000000 !important;
        }

        body.dark-mode #uploadedFileName {
            background-color: #2a2a2a;
            border-left-color: var(--osu-orange);
            color: #000000 !important;
            border-color: #444;
        }

        body.dark-mode #uploadedFileName strong {
            color: #000000 !important;
        }

        body.dark-mode #fileNameDisplay {
            color: #000000 !important;
        }

        #fileNameDisplay {
            color: #000000 !important;
        }

        body.dark-mode .card-body {
            background-color: #2a2a2a;
            color: var(--text-primary);
        }

        body.dark-mode .card-title {
            color: var(--text-primary);
        }

        body.dark-mode strong {
            color: var(--text-primary);
        }

        /* Markdown content styling */
        .markdown-content h1, .markdown-content h2, .markdown-content h3 {
            margin-top: 1.5rem;
            margin-bottom: 1rem;
        }
        .markdown-content ul, .markdown-content ol {
            margin-left: 1.5rem;
            margin-bottom: 1rem;
        }
        .markdown-content p {
            margin-bottom: 0.75rem;
            color: var(--text-primary);
        }
        .markdown-content code {
            background-color: #f5f5f5;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-size: 0.9em;
            color: #333;
        }
        .markdown-content pre {
            background-color: #f5f5f5;
            padding: 1rem;
            border-radius: 5px;
            overflow-x: auto;
            color: #333;
        }

        body.dark-mode .markdown-content code {
            background-color: #3a3a3a;
            color: #e0e0e0;
        }

        body.dark-mode .markdown-content pre {
            background-color: #3a3a3a;
            color: #e0e0e0;
        }
        .markdown-content table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 1rem;
        }
        .markdown-content table th, .markdown-content table td {
            border: 1px solid #ddd;
            padding: 0.5rem;
            text-align: left;
        }
        .markdown-content table th {
            background-color: #f5f5f5;
            font-weight: bold;
        }
        .markdown-content blockquote {
            border-left: 4px solid #ddd;
            padding-left: 1rem;
            margin-left: 0;
            color: #666;
        }

        /* Hide "No file chosen" text in file inputs */
        input[type="file"]::file-selector-button {
            margin-right: 10px;
        }
        input[type="file"] {
            color: transparent;
        }
        input[type="file"]::-webkit-file-upload-button {
            color: #212529;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h1 class="mb-0">{{ title if title else 'Policy / Requirements Evaluator' }}</h1>
            <button id="darkModeToggle" class="btn btn-outline-secondary" style="border-radius: 50%; width: 40px; height: 40px; padding: 0; display: flex; align-items: center; justify-content: center;">
                <span id="darkModeIcon">üåô</span>
            </button>
        </div>

        {% if introduction %}
        <div class="alert alert-info">
            {{ introduction }}
        </div>
        {% endif %}

        {% if error %}
        <div class="alert alert-danger">{{ error }}</div>
        {% endif %}

        <form method="POST" enctype="multipart/form-data" id="uploadForm">
            {% if not static_requirements %}
            <div class="mb-3">
                <label for="policy" class="form-label">Upload the policy or requirements documents (PDF, TXT, or MD files)</label>
                <input type="file" class="form-control" id="policy" name="policy" multiple accept=".pdf,.txt,.md">
                <small class="form-text text-muted d-block mt-2" id="policyDisplay">Requirements</small>
            </div>
            {% endif %}

            <div class="mb-3">
                <label for="submission" class="form-label">Upload the documents you'd like to verify against these requirements (PDF or MD files)</label>
                <input type="file" class="form-control" id="submission" name="submission" required multiple accept=".pdf,.md">
                <small class="form-text text-muted d-block mt-2" id="submissionDisplay">Certificate</small>
            </div>

            <div class="mb-3">
                <button type="submit" class="btn btn-primary" id="submitBtn">Go</button>
            </div>

            <input type="hidden" id="submissionFileName" name="submissionFileName" value="">
            <input type="hidden" id="policyFileName" name="policyFileName" value="">

            <div class="d-none text-center mt-4" id="loadingSpinner">
                <div class="spinner-border" role="status" style="color: var(--osu-orange); border-width: 0.25em;">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3 fw-bold fs-5" id="processingStage">Uploading documents...</p>
            </div>
        </form>
        
        {% if result %}
        <div id="uploadedFileName" style="background-color: #f0f0f0; padding: 15px; margin: 20px 0; border-left: 4px solid var(--osu-orange); border-radius: 4px;">
            <strong>Document Analyzed:</strong> <span id="fileNameDisplay">{{ submission_filename }}</span>
        </div>

        <div class="result-box {{ result.lower() }}">
            {% if result == "GREEN" %}
                {{ result }}: all requirements are fully met
            {% elif result == "YELLOW" %}
                {{ result }}: most requirements are met, but some are only partially compliant and need review
            {% elif result == "ORANGE" %}
                {{ result }}: both numerical and other requirements are ambiguous and need clarification
            {% elif result == "RED" %}
                {{ result }}: one or more requirements are clearly not met
            {% endif %}
        </div>

        {% if inconsistent_warning %}
        <div class="alert alert-warning mt-3" role="alert">
            {{ inconsistent_warning }}
        </div>
        {% endif %}

        {% if json_parsed %}
        <div class="card mt-3">
            <div class="card-body">
                <h5 class="card-title">Detailed Results</h5>
                <div class="mb-3">
                    <strong>Summary:</strong> {{ json_parsed.summary.statement }}<br>
                    <strong>Total Checks:</strong> {{ json_parsed.summary.totalChecks }} |
                    <strong>Passed:</strong> <span class="text-success">{{ json_parsed.summary.passed }}</span> |
                    {% if json_parsed.summary.partial %}<strong>Partial:</strong> <span class="text-warning">{{ json_parsed.summary.partial }}</span> |{% endif %}
                    <strong>Failed:</strong> <span class="text-danger">{{ json_parsed.summary.failed }}</span>
                </div>
                <table class="table table-sm table-bordered">
                    <thead>
                        <tr>
                            <th>Requirement</th>
                            <th>Policy Requirement</th>
                            <th>Submission Value</th>
                            <th>Status</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for req in json_parsed.requirements %}
                        <tr class="{% if req.pass_status == 'PARTIAL' %}table-warning{% elif req.pass %}table-success{% else %}table-danger{% endif %}">
                            <td>{{ req.requirement }}</td>
                            <td>{{ req.policyRequirement }}</td>
                            <td>{{ req.submissionValue }}</td>
                            <td>
                                {% if req.pass_status == 'PARTIAL' %}
                                <span class="badge bg-warning text-dark">Partial</span>
                                {% elif req.pass %}
                                <span class="badge bg-success">Pass</span>
                                {% else %}
                                <span class="badge bg-danger">Fail</span>
                                {% endif %}
                            </td>
                            <td>{{ req.notes }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        {% if json_data %}
        <div class="card mt-3">
            <div class="card-body">
                <h5 class="card-title">Raw JSON Output <small class="text-muted">(model: {{ model_id }})</small></h5>
                <pre class="bg-light p-3 rounded" style="max-height: 400px; overflow-y: auto;"><code>{{ json_data }}</code></pre>
            </div>
        </div>
        {% endif %}

        {% elif explanation %}
        <div class="card mt-3">
            <div class="card-body">
                <div class="card-text">
                    <pre>{{ explanation }}</pre>
                </div>
            </div>
        </div>
        {% endif %}
        {% endif %}
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const form = document.querySelector('form');
        const policyInput = document.getElementById('policy');
        const submissionInput = document.getElementById('submission');
        const submissionDisplay = document.getElementById('submissionDisplay');
        const submitBtn = document.getElementById('submitBtn');
        const loadingSpinner = document.getElementById('loadingSpinner');

        // Update submission display when files are selected
        submissionInput.addEventListener('change', function() {
            if (this.files.length > 0) {
                const files = Array.from(this.files);
                const fileNames = files.map(file => file.name);
                submissionDisplay.textContent = fileNames.join(', ');
            } else {
                submissionDisplay.textContent = 'Certificate';
            }
        });

        // Update policy display when files are selected
        if (policyInput) {
            policyInput.addEventListener('change', function() {
                const policyDisplay = document.getElementById('policyDisplay');
                if (this.files.length > 0) {
                    const files = Array.from(this.files);
                    const fileNames = files.map(file => file.name);
                    policyDisplay.textContent = fileNames.join(', ');
                } else {
                    policyDisplay.textContent = 'Requirements';
                }
            });
        }

        // Hide results when new files are selected
        function hideResults() {
            const resultBoxes = document.querySelectorAll('.result-box, .card, .alert-warning');
            resultBoxes.forEach(box => box.style.display = 'none');
        }

        // Handle Go button click
        submitBtn.addEventListener('click', function(e) {
            if (!submissionInput.files.length) {
                alert('Please select a submission document first');
                e.preventDefault();
                return;
            }

            // Store filenames in hidden fields
            const submissionFileNames = Array.from(submissionInput.files).map(f => f.name).join(', ');
            document.getElementById('submissionFileName').value = submissionFileNames;

            if (policyInput && policyInput.files.length > 0) {
                const policyFileNames = Array.from(policyInput.files).map(f => f.name).join(', ');
                document.getElementById('policyFileName').value = policyFileNames;
            }

            hideResults();
            loadingSpinner.classList.remove('d-none');

            // More detailed progress stages that change frequently
            const stages = [
                'Uploading documents...',
                'Reading PDF files...',
                'Extracting text content...',
                'Analyzing document structure...',
                'Detecting tables and complex elements...',
                'Processing tables with OCR if needed...',
                'Converting document to structured format...',
                'Loading policy requirements...',
                'Preparing AI evaluation...',
                'Analyzing submission against requirements...',
                'Checking numerical values and specifications...',
                'Verifying compliance with all requirements...',
                'Generating detailed evaluation report...',
                'Finalizing results...'
            ];

            let stageIndex = 0;
            const stageElement = document.getElementById('processingStage');

            // Start updating the stage message every 3 seconds
            const stageInterval = setInterval(() => {
                stageIndex++;
                if (stageIndex < stages.length && stageElement) {
                    stageElement.textContent = stages[stageIndex];
                } else {
                    // Stop at the last message, don't loop back
                    clearInterval(stageInterval);
                }
            }, 3000); // Change message every 3 seconds

            // Submit the form
            setTimeout(() => {
                form.submit();
            }, 500);
        });

        // Hide results when policy files are selected
        if (policyInput) {
            policyInput.addEventListener('change', hideResults);
        }

        // Display uploaded file name on page load
        window.addEventListener('load', function() {
            const fileNames = submissionInput.files.length > 0
                ? Array.from(submissionInput.files).map(f => f.name).join(', ')
                : (submissionDisplay.textContent !== 'Certificate' ? submissionDisplay.textContent : '');

            if (fileNames) {
                document.getElementById('fileNameDisplay').textContent = fileNames;
            }
        });

        // Dark mode toggle functionality
        const darkModeToggle = document.getElementById('darkModeToggle');
        const darkModeIcon = document.getElementById('darkModeIcon');
        const body = document.body;

        // Check if dark mode preference is saved in localStorage
        const darkModeEnabled = localStorage.getItem('darkMode') === 'true';
        if (darkModeEnabled) {
            body.classList.add('dark-mode');
            darkModeIcon.textContent = '‚òÄÔ∏è';
        }

        darkModeToggle.addEventListener('click', function() {
            body.classList.toggle('dark-mode');
            const isEnabled = body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isEnabled);
            darkModeIcon.textContent = isEnabled ? '‚òÄÔ∏è' : 'üåô';
        });
    </script>
</body>
</html>
