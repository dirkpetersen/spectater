<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Requirements Evaluator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .result-box {
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
            font-size: 24px;
            font-weight: bold;
            text-align: center;
        }
        .green { background-color: #d4edda; color: #155724; }
        .yellow { background-color: #fff3cd; color: #856404; }
        .orange { background-color: #ffe5d0; color: #ad4f09; }
        .red { background-color: #f8d7da; color: #721c24; }

        /* Markdown content styling */
        .markdown-content h1, .markdown-content h2, .markdown-content h3 {
            margin-top: 1.5rem;
            margin-bottom: 1rem;
        }
        .markdown-content ul, .markdown-content ol {
            margin-left: 1.5rem;
            margin-bottom: 1rem;
        }
        .markdown-content p {
            margin-bottom: 0.75rem;
        }
        .markdown-content code {
            background-color: #f5f5f5;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-size: 0.9em;
        }
        .markdown-content pre {
            background-color: #f5f5f5;
            padding: 1rem;
            border-radius: 5px;
            overflow-x: auto;
        }
        .markdown-content table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 1rem;
        }
        .markdown-content table th, .markdown-content table td {
            border: 1px solid #ddd;
            padding: 0.5rem;
            text-align: left;
        }
        .markdown-content table th {
            background-color: #f5f5f5;
            font-weight: bold;
        }
        .markdown-content blockquote {
            border-left: 4px solid #ddd;
            padding-left: 1rem;
            margin-left: 0;
            color: #666;
        }

        /* Hide "No file chosen" text in file inputs */
        input[type="file"]::file-selector-button {
            margin-right: 10px;
        }
        input[type="file"] {
            color: transparent;
        }
        input[type="file"]::-webkit-file-upload-button {
            color: #212529;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-4">{{ title if title else 'Policy / Requirements Evaluator' }}</h1>

        {% if introduction %}
        <div class="alert alert-info">
            {{ introduction }}
        </div>
        {% endif %}

        {% if error %}
        <div class="alert alert-danger">{{ error }}</div>
        {% endif %}

        <form method="POST" enctype="multipart/form-data" id="uploadForm">
            {% if not static_requirements %}
            <div class="mb-3">
                <label for="policy" class="form-label">Upload the policy or requirements documents (PDF, TXT, or MD files)</label>
                <input type="file" class="form-control" id="policy" name="policy" multiple accept=".pdf,.txt,.md">
                <small class="form-text text-muted" id="policyHelp">Previously uploaded files will use cached analysis</small>
            </div>
            {% endif %}

            <div class="mb-3">
                <label for="submission" class="form-label">Upload the documents you'd like to verify against these requirements (PDF or MD files)</label>
                <input type="file" class="form-control" id="submission" name="submission" required multiple accept=".pdf,.md">
                <small class="form-text text-muted" id="submissionHelp">Previously uploaded files will use cached analysis</small>
            </div>

            <div class="d-none text-center mt-4" id="loadingSpinner">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3 fw-bold fs-5" id="processingStage">Uploading documents...</p>
            </div>
        </form>
        
        {% if result %}
        <div class="result-box {{ result.lower() }}">
            {% if result == "GREEN" %}
                {{ result }}: all requirements are fully met
            {% elif result == "YELLOW" %}
                {{ result }}: all quantifiable/numerical requirements are met but other requirements are ambiguous
            {% elif result == "ORANGE" %}
                {{ result }}: both numerical and other requirements are ambiguous and need clarification
            {% elif result == "RED" %}
                {{ result }}: one or more requirements are clearly not met
            {% endif %}
        </div>

        {% if inconsistent_warning %}
        <div class="alert alert-warning mt-3" role="alert">
            {{ inconsistent_warning }}
        </div>
        {% endif %}

        {% if json_parsed %}
        <div class="card mt-3">
            <div class="card-body">
                <h5 class="card-title">Detailed Results</h5>
                <div class="mb-3">
                    <strong>Summary:</strong> {{ json_parsed.summary.statement }}<br>
                    <strong>Total Checks:</strong> {{ json_parsed.summary.totalChecks }} |
                    <strong>Passed:</strong> <span class="text-success">{{ json_parsed.summary.passed }}</span> |
                    <strong>Failed:</strong> <span class="text-danger">{{ json_parsed.summary.failed }}</span>
                </div>
                <table class="table table-sm table-bordered">
                    <thead>
                        <tr>
                            <th>Requirement</th>
                            <th>Policy Requirement</th>
                            <th>Submission Value</th>
                            <th>Status</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for req in json_parsed.requirements %}
                        <tr class="{% if req.pass %}table-success{% else %}table-danger{% endif %}">
                            <td>{{ req.requirement }}</td>
                            <td>{{ req.policyRequirement }}</td>
                            <td>{{ req.submissionValue }}</td>
                            <td>
                                {% if req.pass %}
                                <span class="badge bg-success">Pass</span>
                                {% else %}
                                <span class="badge bg-danger">Fail</span>
                                {% endif %}
                            </td>
                            <td>{{ req.notes }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        {% if json_data %}
        <div class="card mt-3">
            <div class="card-body">
                <h5 class="card-title">Raw JSON Output <small class="text-muted">(model: {{ model_id }})</small></h5>
                <pre class="bg-light p-3 rounded" style="max-height: 400px; overflow-y: auto;"><code>{{ json_data }}</code></pre>
            </div>
        </div>
        {% endif %}

        {% elif explanation %}
        <div class="card mt-3">
            <div class="card-body">
                <div class="card-text">
                    <pre>{{ explanation }}</pre>
                </div>
            </div>
        </div>
        {% endif %}
        {% endif %}
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const form = document.querySelector('form');
        const policyInput = document.getElementById('policy');
        const submissionInput = document.getElementById('submission');
        const loadingSpinner = document.getElementById('loadingSpinner');

        // Store files when selected and update display immediately
        function handleFileSelect(input, storageKey) {
            input.addEventListener('change', function() {
                if (this.files.length > 0) {
                    const files = Array.from(this.files);
                    const fileNames = files.map(file => file.name);
                    localStorage.setItem(storageKey + '_names', JSON.stringify(fileNames));

                    // Update display immediately
                    const helpText = input.nextElementSibling;
                    helpText.innerHTML = `Uploaded: ${fileNames.join(', ')}`;
                    helpText.classList.add('text-primary');
                }
            });
        }

        if (policyInput) {
            handleFileSelect(policyInput, 'policy');
        }
        handleFileSelect(submissionInput, 'submission');

        // Hide results when new files are selected
        function hideResults() {
            const resultBoxes = document.querySelectorAll('.result-box, .card, .alert-warning');
            resultBoxes.forEach(box => box.style.display = 'none');
        }

        // Auto-submit form when submission files are selected
        let formSubmitted = false;

        submissionInput.addEventListener('change', function() {
            if (this.files.length > 0 && !formSubmitted) {
                hideResults();

                // Show loading spinner
                loadingSpinner.classList.remove('d-none');

                // More detailed progress stages that change frequently
                const stages = [
                    'Uploading documents...',
                    'Reading PDF files...',
                    'Extracting text content...',
                    'Analyzing document structure...',
                    'Detecting tables and complex elements...',
                    'Processing tables with OCR if needed...',
                    'Converting document to structured format...',
                    'Loading policy requirements...',
                    'Preparing AI evaluation...',
                    'Analyzing submission against requirements...',
                    'Checking numerical values and specifications...',
                    'Verifying compliance with all requirements...',
                    'Generating detailed evaluation report...',
                    'Finalizing results...'
                ];

                let stageIndex = 0;
                const stageElement = document.getElementById('processingStage');

                // Start updating the stage message every 3 seconds
                const stageInterval = setInterval(() => {
                    stageIndex++;
                    if (stageIndex < stages.length && stageElement) {
                        stageElement.textContent = stages[stageIndex];
                    } else {
                        // Stop at the last message, don't loop back
                        clearInterval(stageInterval);
                    }
                }, 3000); // Change message every 3 seconds

                // Actually submit the form after a brief delay to show first status
                setTimeout(() => {
                    formSubmitted = true;
                    form.submit();
                }, 500);
            }
        });

        // Hide results when policy files are selected
        if (policyInput) {
            policyInput.addEventListener('change', hideResults);
        }

        // Update file input display
        function updateFileDisplay(input, storageKey) {
            const fileNames = JSON.parse(localStorage.getItem(storageKey + '_names') || '[]');
            if (fileNames.length) {
                const helpText = input.nextElementSibling;
                helpText.innerHTML = `Uploaded: ${fileNames.join(', ')}`;
                helpText.classList.add('text-primary');
            }
        }

        // Restore file information on page load
        window.addEventListener('load', function() {
            if (policyInput) {
                updateFileDisplay(policyInput, 'policy');
            }
            updateFileDisplay(submissionInput, 'submission');
        });

        // Handle policy file selection
        if (policyInput) {
            policyInput.addEventListener('click', function() {
                if (!confirm('Do you want to upload a new policy document? The current one will be replaced.')) {
                    event.preventDefault();
                    return;
                }
                localStorage.removeItem('policy_names');
            });
        }

        submissionInput.addEventListener('click', function() {
            localStorage.removeItem('submission_names');
            // Clear the label immediately
            const helpText = submissionInput.nextElementSibling;
            helpText.innerHTML = 'Previously uploaded files will use cached analysis';
            helpText.classList.remove('text-primary');
        });
    </script>
</body>
</html>
